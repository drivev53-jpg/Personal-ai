<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>Universal AI Chat ¬∑ Gemini clone</title>
  <!-- Tailwind (light + dark ready) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Markdown + sanitizer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.4/purify.min.js"></script>
  <style>
    /* Smooth sidebar transition & loading fallback */
    #loading { display: flex; }
    #app { display: none; }
    .sidebar-transition { transition: transform 0.2s ease-in-out; }
    /* Ensure text contrast in dark mode */
    .dark .bg-white { background-color: #1f2937; }
    .dark .text-gray-900 { color: #f3f4f6; }
    /* Simple code block styling */
    pre { background: #f4f4f5; padding: 0.75rem; border-radius: 0.5rem; overflow-x: auto; }
    .dark pre { background: #111827; }
    code { font-family: monospace; }
  </style>
</head>
<body class="antialiased min-h-screen flex flex-col bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">

  <!-- FALLBACK LOADER ‚Äì hidden once JS runs -->
  <div id="loading" class="fixed inset-0 flex items-center justify-center bg-white dark:bg-gray-900 z-50">
    <div class="text-xl text-gray-600 dark:text-gray-300">Loading App...</div>
  </div>

  <!-- MAIN APP (hidden until JS initializes) -->
  <div id="app" class="flex min-h-screen w-full">

    <!-- SIDEBAR (mobile sliding) -->
    <div id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-gray-50 dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 transform -translate-x-full md:translate-x-0 md:static md:w-80 z-30 flex flex-col sidebar-transition shadow-lg md:shadow-none">
      <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
        <h2 class="font-semibold text-lg">Chat history</h2>
        <button id="newChatBtn" class="text-sm bg-blue-600 text-white px-3 py-1.5 rounded-md hover:bg-blue-700">+ New</button>
      </div>
      <!-- Chat list container -->
      <div id="chatList" class="flex-1 overflow-y-auto p-2 space-y-1">
        <!-- dynamic chats will appear here -->
      </div>
      <div class="p-3 text-xs text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700">
        OpenRouter ¬∑ deepseek default
      </div>
    </div>

    <!-- MAIN PANEL -->
    <div class="flex-1 flex flex-col min-h-screen w-full max-w-full">

      <!-- HEADER with mobile toggle + controls -->
      <header class="flex items-center p-3 border-b border-gray-200 dark:border-gray-700 bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm sticky top-0 z-20">
        <button id="menuToggle" class="md:hidden mr-3 text-2xl focus:outline-none">‚ò∞</button>
        <h1 class="font-medium truncate">AI Chat</h1>
        <div class="flex-1"></div>
        <!-- System prompt (per chat) quick edit -->
        <button id="editSystemPromptBtn" class="mr-2 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800" title="Edit system prompt for this chat">üìù</button>
        <!-- Settings cog -->
        <button id="settingsToggle" class="mr-2 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800" title="Settings">‚öôÔ∏è</button>
        <!-- Dark mode toggle -->
        <button id="darkToggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800" title="Dark mode">üåô</button>
      </header>

      <!-- MESSAGES CONTAINER (flex grow + scroll) -->
      <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4 pb-24 md:pb-4">
        <!-- messages appear here -->
      </div>

      <!-- BOTTOM INPUT BAR (always visible, sticky on mobile) -->
      <div class="sticky bottom-0 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 p-3">
        <form id="messageForm" class="flex items-center gap-2 max-w-4xl mx-auto">
          <input id="messageInput" type="text" placeholder="Ask anything..." autocomplete="off"
                 class="flex-1 p-3 border border-gray-300 dark:border-gray-600 rounded-full bg-gray-50 dark:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-white">
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full w-12 h-12 flex items-center justify-center">
            <span class="text-xl">‚û§</span>
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- SETTINGS MODAL (API key, model, global system prompt) -->
  <div id="settingsModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl max-w-md w-full p-6 shadow-xl">
      <h2 class="text-xl font-bold mb-4">Settings</h2>
      <label class="block mb-2 text-sm">OpenRouter API Key</label>
      <input type="password" id="apiKeyInput" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 mb-4" placeholder="sk-or-...">

      <label class="block mb-2 text-sm">Model (e.g. deepseek/deepseek-r1:free)</label>
      <input type="text" id="modelInput" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 mb-4" value="deepseek/deepseek-r1:free">

      <label class="block mb-2 text-sm">Default system prompt (for new chats)</label>
      <textarea id="defaultSystemPrompt" rows="3" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 mb-6">You are a helpful AI assistant.</textarea>

      <div class="flex justify-end gap-2">
        <button id="closeSettings" class="px-4 py-2 border rounded hover:bg-gray-100 dark:hover:bg-gray-700">Cancel</button>
        <button id="saveSettings" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save</button>
      </div>
    </div>
  </div>

  <!-- PER-CHAT SYSTEM PROMPT MODAL -->
  <div id="systemPromptModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl max-w-md w-full p-6">
      <h2 class="text-xl font-bold mb-4">Edit system prompt (this chat)</h2>
      <textarea id="chatSystemPromptInput" rows="5" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 mb-6"></textarea>
      <div class="flex justify-end gap-2">
        <button id="closeSystemPrompt" class="px-4 py-2 border rounded hover:bg-gray-100 dark:hover:bg-gray-700">Cancel</button>
        <button id="saveSystemPrompt" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save</button>
      </div>
    </div>
  </div>

  <!-- Tiny extra style for messages -->
  <style>
    .message pre { margin: 0.5rem 0; }
    .message p { margin: 0.25rem 0; }
    #messagesContainer { scroll-behavior: smooth; }
    /* Ensure input not hidden behind keyboard on mobile */
    @media (max-width: 768px) {
      .sticky { position: sticky; }
    }
    /* User message bubble */
    .user-message { background-color: #e5f0ff; color: #1e293b; }
    .dark .user-message { background-color: #1e3a5f; color: #f0f9ff; }
    .ai-message { background-color: #f2f2f5; color: #1e293b; }
    .dark .ai-message { background-color: #2d2f36; color: #f0f2f5; }
  </style>

  <script>
    (function() {
      // ---------- HIDE FALLBACK LOADER ----------
      const loadingEl = document.getElementById('loading');
      const appEl = document.getElementById('app');
      if (loadingEl) loadingEl.style.display = 'none';
      if (appEl) appEl.style.display = 'flex';

      // ---------- GLOBAL STATE ----------
      let chats = [];                       // array of { id, title, messages, systemPrompt }
      let currentChatId = null;
      let apiKey = '';
      let model = 'deepseek/deepseek-r1:free';
      let defaultSystemPrompt = 'You are a helpful AI assistant.';
      let darkMode = false;

      // UI elements
      const sidebarEl = document.getElementById('sidebar');
      const menuToggle = document.getElementById('menuToggle');
      const messagesContainer = document.getElementById('messagesContainer');
      const messageForm = document.getElementById('messageForm');
      const messageInput = document.getElementById('messageInput');
      const chatListEl = document.getElementById('chatList');
      const newChatBtn = document.getElementById('newChatBtn');
      const settingsToggle = document.getElementById('settingsToggle');
      const settingsModal = document.getElementById('settingsModal');
      const closeSettings = document.getElementById('closeSettings');
      const saveSettings = document.getElementById('saveSettings');
      const apiKeyInput = document.getElementById('apiKeyInput');
      const modelInput = document.getElementById('modelInput');
      const defaultSystemPromptInput = document.getElementById('defaultSystemPrompt');
      const darkToggle = document.getElementById('darkToggle');
      const editSystemPromptBtn = document.getElementById('editSystemPromptBtn');
      const systemPromptModal = document.getElementById('systemPromptModal');
      const chatSystemPromptInput = document.getElementById('chatSystemPromptInput');
      const closeSystemPrompt = document.getElementById('closeSystemPrompt');
      const saveSystemPrompt = document.getElementById('saveSystemPrompt');

      // ---------- LOAD FROM LOCALSTORAGE ----------
      function loadState() {
        try {
          const savedChats = localStorage.getItem('chats');
          if (savedChats) chats = JSON.parse(savedChats) || [];
          const savedCurrentId = localStorage.getItem('currentChatId');
          if (savedCurrentId) currentChatId = savedCurrentId;
          apiKey = localStorage.getItem('apiKey') || '';
          model = localStorage.getItem('model') || 'deepseek/deepseek-r1:free';
          defaultSystemPrompt = localStorage.getItem('defaultSystemPrompt') || 'You are a helpful AI assistant.';
          darkMode = localStorage.getItem('darkMode') === 'true';

          // Apply dark mode
          if (darkMode) document.documentElement.classList.add('dark');
          else document.documentElement.classList.remove('dark');
        } catch (e) {
          console.warn('localStorage error', e);
        }
        // Ensure at least one chat exists
        if (!chats.length) createNewChatInternal();
        if (!currentChatId || !chats.find(c => c.id === currentChatId)) {
          if (chats.length) currentChatId = chats[0].id;
        }
      }

      function saveState() {
        try {
          localStorage.setItem('chats', JSON.stringify(chats));
          if (currentChatId) localStorage.setItem('currentChatId', currentChatId);
          localStorage.setItem('apiKey', apiKey);
          localStorage.setItem('model', model);
          localStorage.setItem('defaultSystemPrompt', defaultSystemPrompt);
          localStorage.setItem('darkMode', darkMode);
        } catch (e) {}
      }

      // ---------- HELPERS ----------
      function generateId() { return Date.now() + '-' + Math.random().toString(36).substring(2); }

      function createNewChatInternal() {
        const newChat = {
          id: generateId(),
          title: 'New conversation',
          messages: [],
          systemPrompt: defaultSystemPrompt   // per-chat system prompt
        };
        chats.unshift(newChat);
        currentChatId = newChat.id;
        saveState();
        renderSidebar();
        renderMessages();
        return newChat;
      }

      // ---------- RENDER SIDEBAR ----------
      function renderSidebar() {
        if (!chatListEl) return;
        let html = '';
        chats.forEach(chat => {
          const activeClass = chat.id === currentChatId ? 'bg-blue-100 dark:bg-blue-900/30 border-l-4 border-blue-600' : '';
          html += `<div class="p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700 cursor-pointer flex items-center justify-between group ${activeClass}" data-chat-id="${chat.id}">
            <span class="truncate text-sm flex-1 chat-title">${escapeHtml(chat.title)}</span>
            <div class="flex gap-1 opacity-0 group-hover:opacity-100">
              <button class="rename-chat p-1 text-xs" title="Rename">‚úèÔ∏è</button>
              <button class="delete-chat p-1 text-xs" title="Delete">üóëÔ∏è</button>
            </div>
          </div>`;
        });
        chatListEl.innerHTML = html;

        // Attach click to each chat row
        document.querySelectorAll('[data-chat-id]').forEach(row => {
          row.addEventListener('click', (e) => {
            // ignore if clicking on buttons
            if (e.target.closest('button')) return;
            const cid = row.dataset.chatId;
            if (cid) switchChat(cid);
          });
        });
        // delete & rename
        document.querySelectorAll('.delete-chat').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const row = btn.closest('[data-chat-id]');
            if (row && confirm('Delete this chat?')) deleteChat(row.dataset.chatId);
          });
        });
        document.querySelectorAll('.rename-chat').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const row = btn.closest('[data-chat-id]');
            if (row) {
              const newTitle = prompt('Enter new chat name:', row.querySelector('.chat-title')?.textContent || '');
              if (newTitle) renameChat(row.dataset.chatId, newTitle);
            }
          });
        });
      }

      // simple escape for chat titles
      function escapeHtml(unsafe) {
        return unsafe.replace(/[&<>"]/g, function(m) {
          if(m === '&') return '&amp;'; if(m === '<') return '&lt;'; if(m === '>') return '&gt;'; if(m === '"') return '&quot;';
          return m;
        });
      }

      // switch active chat
      function switchChat(chatId) {
        if (!chatId) return;
        const chat = chats.find(c => c.id === chatId);
        if (!chat) return;
        currentChatId = chatId;
        saveState();
        renderSidebar();
        renderMessages();
        // close sidebar on mobile after selection
        if (window.innerWidth < 768) sidebarEl.classList.add('-translate-x-full');
      }

      function deleteChat(chatId) {
        chats = chats.filter(c => c.id !== chatId);
        if (currentChatId === chatId) {
          currentChatId = chats.length ? chats[0].id : null;
        }
        if (!chats.length) createNewChatInternal();
        saveState();
        renderSidebar();
        renderMessages();
      }

      function renameChat(chatId, newTitle) {
        const chat = chats.find(c => c.id === chatId);
        if (chat) { chat.title = newTitle; saveState(); renderSidebar(); }
      }

      // ---------- RENDER MESSAGES (current chat) ----------
      function renderMessages() {
        messagesContainer.innerHTML = '';
        const chat = chats.find(c => c.id === currentChatId);
        if (!chat) return;

        chat.messages.forEach(msg => {
          appendMessageToDOM(msg.role, msg.content);
        });
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function appendMessageToDOM(role, content, isStream = false, msgId = null) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `message flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
        const bubble = document.createElement('div');
        bubble.className = `max-w-[80%] md:max-w-[70%] rounded-2xl px-4 py-2 ${role === 'user' ? 'user-message' : 'ai-message'}`;
        if (isStream) bubble.setAttribute('data-streaming-id', msgId || 'streaming');

        // render markdown (sanitized)
        const rawHtml = marked.parse(content, { async: false }); // sync parse
        const cleanHtml = DOMPurify.sanitize(rawHtml);
        bubble.innerHTML = cleanHtml;
        msgDiv.appendChild(bubble);
        messagesContainer.appendChild(msgDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        return bubble;
      }

      // ---------- UPDATE STREAMING MESSAGE ----------
      function updateStreamingMessage(chatId, accumulated) {
        const chat = chats.find(c => c.id === chatId);
        if (!chat) return;
        // find last assistant message that is likely streaming (or create one)
        let lastMsg = chat.messages[chat.messages.length - 1];
        if (!lastMsg || lastMsg.role !== 'assistant') {
          lastMsg = { role: 'assistant', content: '' };
          chat.messages.push(lastMsg);
        }
        lastMsg.content = accumulated;

        // update DOM streaming bubble if exists, else create
        let bubble = document.querySelector('[data-streaming-id]');
        if (!bubble) {
          // create fresh assistant bubble
          const msgDiv = document.createElement('div');
          msgDiv.className = 'message flex justify-start';
          bubble = document.createElement('div');
          bubble.className = 'max-w-[80%] md:max-w-[70%] rounded-2xl px-4 py-2 ai-message';
          bubble.setAttribute('data-streaming-id', 'streaming');
          msgDiv.appendChild(bubble);
          messagesContainer.appendChild(msgDiv);
        }
        const rawHtml = marked.parse(accumulated, { async: false });
        bubble.innerHTML = DOMPurify.sanitize(rawHtml);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function finishStreaming(chatId) {
        document.querySelectorAll('[data-streaming-id]').forEach(el => el.removeAttribute('data-streaming-id'));
        saveState();
        renderSidebar(); // title might update if first message
      }

      // ---------- SEND MESSAGE (STREAMING) ----------
      async function sendMessage(userText) {
        if (!userText.trim()) return;
        const chat = chats.find(c => c.id === currentChatId);
        if (!chat) return;

        // Add user message
        chat.messages.push({ role: 'user', content: userText });
        appendMessageToDOM('user', userText);
        messageInput.value = '';
        saveState();

        // If this is the first user message, update chat title
        if (chat.messages.filter(m => m.role === 'user').length === 1) {
          chat.title = userText.substring(0, 30) + (userText.length > 30 ? '‚Ä¶' : '');
          renderSidebar();
        }

        // Prepare API call
        if (!apiKey) {
          alert('Please set your OpenRouter API key in settings.');
          return;
        }

        const messagesForAPI = [];
        // Add system prompt from chat
        if (chat.systemPrompt) {
          messagesForAPI.push({ role: 'system', content: chat.systemPrompt });
        }
        // Add conversation history (excluding the current user message? we already added, include all)
        chat.messages.forEach(m => messagesForAPI.push({ role: m.role, content: m.content }));

        try {
          const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${apiKey}`,
              'Content-Type': 'application/json',
              'HTTP-Referer': window.location.origin, // optional
              'X-Title': 'Universal AI Chat'
            },
            body: JSON.stringify({
              model: model,
              messages: messagesForAPI,
              stream: true
            })
          });

          if (!response.ok) {
            const errText = await response.text();
            throw new Error(`API error ${response.status}: ${errText}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder('utf-8');
          let done = false;
          let accumulated = '';

          while (!done) {
            const { value, done: readerDone } = await reader.read();
            done = readerDone;
            if (value) {
       
